(function(a){a.shakeMap=function(A,f){var y,i,k,e,B,w,m,j,h,z,o,u,q,p,c;A=(typeof A=="string")?a(A).get(0):A;if(!(a(A).data("shakeMap"))){y=a.extend(true,{},a.shakeMap.defaults);a.extend(true,y,f);p={gridSize:y.grid_size,maxZoom:y.max_zoom,styles:y.cluster_styles};var t=function(H,E){var G,F;k=[];o=[];if(H){u=E}else{u=y.data}q=u.points.length;j=g(H);if(H){w.clearMarkers();google.maps.event.trigger(B,"resize");B.fitBounds(j);if(y.use_spider==true){c.clearMarkers()}}else{B=s();if(y.use_spider==true){c=new OverlappingMarkerSpiderfier(B,{markersWontMove:true,markersWontHide:true});for(var C=0;C<q;C++){k.push(c.addMarker(b(u.points[C])))}w=new MarkerClusterer(B,c.getMarkers(),p);c.addListener("click",function(I){v(I)})}else{for(var C=0;C<q;C++){k.push(b(u.points[C]))}w=new MarkerClusterer(B,k,p)}if(y.clusterer_styles.length!=0){var D=y.clusterer_styles;w.setStyles(D)}if(y.use_geo==true){navigator.geolocation.getCurrentPosition(d,x)}}if(H){if(y.use_spider==true){c=new OverlappingMarkerSpiderfier(B,{markersWontMove:true,markersWontHide:true});for(var C=0;C<q;C++){k.push(c.addMarker(b(u.points[C])))}w=new MarkerClusterer(B,c.getMarkers(),p);c.addListener("click",function(I){v(I)})}else{for(var C=0;C<q;C++){k.push(b(u.points[C]));setMarkerAction(k[C])}w=new MarkerClusterer(B,k,p)}}else{google.maps.event.addListener(w,"loaded",function(){n()})}if(y.resizer!=""){a(y.resizer).click(function(){var I=B.getCenter();var J="#"+B.b.id;a(J).animate({height:y.resizer_height},500,function(){google.maps.event.trigger(B,"resize");B.setCenter(I)});return false})}};var d=function(C){var D=C.coords;B.setCenter(new google.maps.LatLng(D.latitude,D.longitude));B.setZoom(10);var F=a.shakeMap.makeGLatLng({lat:D.latitude,lng:D.longitude});var E=new google.maps.Marker({position:F,icon:"home.png",map:B});k.push(E);w.clearMarkers();w=new MarkerClusterer(B,k,p)};var x=function(C){console.log(C)};var s=function(){var C,F,E,G,D;if(y.style!=false){C="custom";if(y.styles){F=y.styles}E={navigationControlOptions:{style:google.maps.NavigationControlStyle.LARGE},mapTypeControl:false,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,C]},mapTypeId:C,zoom:9,scrollwheel:false};G={name:"custom"};D=new google.maps.StyledMapType(F,G);B=new google.maps.Map(A,E);B.mapTypes.set(C,D)}else{E={zoomControlOptions:{style:google.maps.ZoomControlStyle.DEFAULT},mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:18,zoom:9};B=new google.maps.Map(A,E)}if(q>1){B.fitBounds(j)}else{B.setCenter(new google.maps.LatLng(u.points[0].point.lat,u.points[0].point.lng));if(y.force_zoom_level){B.setZoom(y.force_zoom_level)}}return B};var g=function(H){var G,F,E;if(q){F=a.shakeMap.makeGLatLng(u.points[0].point)}else{F=a.shakeMap.makeGLatLng(setting.default_point)}G=new google.maps.LatLngBounds(F,F);E=u.points.length;for(var D=1,C=E;D<C;D++){G.extend(a.shakeMap.makeGLatLng(u.points[D].point))}return G};var r=function(D){if(y.category_icon_options){var C=y.category_icon_options;return C[D]||C["default"]}else{return{}}};var b=function(C){var P=a(C),D,O,M,N,H,L,J,E,G,F;O=a.shakeMap.makeGLatLng(C.point);if(y.category_icon_options){G=r(C.point.categoria);L=new google.maps.Marker({icon:G,position:O,map:B})}else{L=new google.maps.Marker({position:O,map:B})}if(C.point.url){L.url=C.point.url}if(C.point.informazioni){L.desc=C.point.informazioni}if(y.use_spider==false){switch(y.marker_action){case"infowindow":var K=new google.maps.InfoWindow({content:L.desc});o.push(K);google.maps.event.addListener(L,"click",function(){a.each(o,function(Q,R){if(K!=R){R.close()}});K.open(L.get("map"),L)});break;case"infobox":var I=new InfoBox(l(C.point.informazioni));o.push(I);google.maps.event.addListener(L,"click",function(){a.each(o,function(Q,R){if(I!=R){R.close()}});I.open(L.get("map"),L)});break;case"click":google.maps.event.addListener(L,"click",function(){y.onClick(this)});break}}return L};var v=function(D){switch(y.marker_action){case"infowindow":infowindow=new google.maps.InfoWindow({content:D.desc});o.push(infowindow);a.each(o,function(E,F){if(infowindow!=F){F.close()}});infowindow.open(B,D);break;case"infobox":var C=new InfoBox(l(D.desc));o.push(C);a.each(o,function(E,F){if(C!=F){F.close()}});C.open(B,D);break;case"click":y.onClick(D);break}};var l=function(C){var E,D;D=y.infobox_settings.offset;E={content:C,disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(D[0],D[1]),zIndex:null,boxStyle:{background:"url("+y.infobox_settings.background+") left top no-repeat",opacity:1,width:y.infobox_settings.width,height:y.infobox_settings.height},closeBoxMargin:y.infobox_settings.closeBoxMargin,closeBoxURL:y.infobox_settings.closeBoxURL,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};return E};var n=function(){if(y.always_show_markers==true){min_zoom=0}w.addMarkers(k)};if(a(document).trigger("beforeMapping.shakeMap",[y])!=false){t();e=true}else{e=false}z={gmarkers:i,settings:y,mapped:e,map:B,getBounds:g,update:function(C){if(a(document).trigger("beforeUpdate.jMapping",[this])!=false){t(true,C);
this.map=B;this.marker=k;this.markerManager=w;a(document).trigger("afterUpdate.shakeMap",[this])}}};a(document).trigger("afterMapping.shakeMap",[z]);return z}else{return a(A).data("shakeMap")}};a.extend(a.shakeMap,{defaults:{data:{},grid_size:50,max_zoom:15,clusterer_styles:[],default_point:{lat:0,lng:0},use_geo:false,styled:false,styled_obj:{},infobox_settings:{offset:[0,0],width:"",height:"",background:"",closeBoxMargin:"9px 38px 2px 2px",closeBoxURL:""},marker_action:"infowindow",resizer:"",resizer_height:0,use_spider:false,onClick:function(b){}},makeGLatLng:function(b){return new google.maps.LatLng(b.lat,b.lng)}});a.fn.shakeMap=function(c,b){if((c=="update")&&a(this[0]).data("shakeMap")){a(this[0]).data("shakeMap").update(b)}else{if(c=="update"){c={}}a(this[0]).data("shakeMap",a.shakeMap(this[0],c))}return this}})(jQuery);