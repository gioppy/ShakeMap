jQuery.skmap={mapHash:[],markerManager:[],markers:[],gmarkers:[],infowindows:[],rawPosition:[],oms:[]};(function(h){var f,j,c,b,a,k,g;var e={makeLatLng:function(l){return new google.maps.LatLng(l[1],l[0])},getBounds:function(){var p,o,n;if(c){o=e.makeLatLng(j.features[0].geometry.coordinates)}else{o=e.makeLatLng(setting.defaultPoint)}p=new google.maps.LatLngBounds(o,o);n=j.features.length;for(var m=1,l=n;m<l;m++){p.extend(e.makeLatLng(j.features[m].geometry.coordinates))}return p},addMarker:function(r,p){var m,n,o;o=f.sidebar.mid;m=e.makeLatLng(p.geometry.coordinates);if(h.isEmptyObject(f.categoryIcons.options)){n=new google.maps.Marker({position:m,map:h.skmap.mapHash[i.getMap(r)].map})}else{category=f.categoryIcons.field_name;icon_options=e.markerIcon(f.categoryIcons,p.properties[category]);n=new google.maps.Marker({icon:icon_options,position:m,map:h.skmap.mapHash[i.getMap(r)].map})}if(p.properties.description){n.desc=p.properties.description}switch(f.action){case"infowindow":var q=new google.maps.InfoWindow({content:n.desc});if(!h.isEmptyObject(f.infowindowOptions)){q.setOptions(f.infowindowOptions)}h.skmap.infowindows[i.getMap(r)].push(q);google.maps.event.addListener(n,"click",function(){h.each(h.skmap.infowindows[i.getMap(r)],function(s,t){if(q!=t){t.close()}});q.open(h.skmap.mapHash[i.getMap(r)].map,n)});break;case"direct":google.maps.event.addListener(n,"click",function(){f.markerClick(this)});break;case"infobox":var l=new InfoBox(i.setInfobox(n.desc));h.skmap.infowindows[i.getMap(r)].push(l);google.maps.event.addListener(n,"click",function(){h.each(h.skmap.infowindows[i.getMap(r)],function(s,t){if(l!=t){t.close()}});l.open(h.skmap.mapHash[i.getMap(r)].map,n)});break;case"null":return;break}if(f.sidebar.active==true){h.skmap.gmarkers[i.getMap(r)][parseInt(p.properties[o],10)]=n;i.attachEvent(r)}return n},markerIcon:function(t,m){var o,q,l,s,r,p,n;q=t.options;l=q[m];s=t.size;r=t.origin;p=t.anchor;n=new google.maps.MarkerImage(l,new google.maps.Size(s[0],s[1]),new google.maps.Point(r[0],r[1]),new google.maps.Point(p[0],p[1]));return n},updateClusterer:function(){markerManager.addMarkers(marker)},geolocationError:function(l){f.geolocation.onError(l)},geolocationFormatIcon:function(n){var m,o,l;m=f.categoryIcons.field_name;l=[];if(f.geolocation.manualCoords.length>0){l[0]=f.geolocation.manualCoords[1];l[1]=f.geolocation.manualCoords[0]}else{l=[h.skmap.rawPosition[i.getMap(n)].longitude,h.skmap.rawPosition[i.getMap(n)].latitude]}o={type:"Feature",geometry:{type:"Point",coordinates:l},properties:{name:"",description:"",nid:""}};o.properties[m]="user";return o},map:function(q){var m,p,n,o,l;m={zoomControlOptions:{style:google.maps.ZoomControlStyle.DEFAULT},mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:18,zoom:9};h.extend(m,f.mapOptions);google.maps.visualRefresh=true;if(f.mapStyle.length>0){p="custom";m.mapTypeControlOptions={mapTypeIds:[google.maps.MapTypeId.ROADMAP,p]};m.mapTypeId=p;n=f.mapStyle;o={name:"custom"};l=new google.maps.StyledMapType(n,o);k=new google.maps.Map(q,m);k.mapTypes.set(p,l)}else{k=new google.maps.Map(q,m)}if(c>1){k.fitBounds(a)}else{k.setCenter(new google.maps.LatLng(j.features[0].geometry.coordinates[1],j.features[0].geometry.coordinates[0]))}var r={map:"",mapKey:""};r.map=k;r.mapKey=q;h.skmap.mapHash.push(r)},set:function(m,n){if(n){if(h.skmap.rawPosition[i.getMap(m)]){j.features.push(e.geolocationFormatIcon(m))}}else{h.skmap.gmarkers.push(new Object);h.skmap.infowindows.push(new Array)}c=j.features.length;a=e.getBounds();if(n){h.skmap.markers[i.getMap(m)]=[];h.skmap.markerManager[i.getMap(m)].clearMarkers();h.skmap.mapHash[i.getMap(m)].map.fitBounds(a);if(f.spider===true){h.skmap.oms[i.getMap(m)].clearMarkers()}}else{h.skmap.markers.push(new Array);e.map(m);if(f.spider===true){h.skmap.oms[i.getMap(m)]=new OverlappingMarkerSpiderfier(h.skmap.mapHash[i.getMap(m)].map,{markersWontMove:true,markersWontHide:true});for(var l=0;l<c;l++){h.skmap.markers[i.getMap(m)].push(h.skmap.oms[i.getMap(m)].addMarker(e.addMarker(m,j.features[l])))}h.skmap.markerManager.push(new MarkerClusterer(h.skmap.mapHash[i.getMap(m)].map,h.skmap.oms[i.getMap(m)].getMarkers(),b))}else{for(var l=0;l<c;l++){h.skmap.markers[i.getMap(m)].push(e.addMarker(m,j.features[l]))}h.skmap.markerManager.push(new MarkerClusterer(h.skmap.mapHash[i.getMap(m)].map,h.skmap.markers[i.getMap(m)],b))}if(h.skmap.markers[i.getMap(m)].length==1&&f.autoOpen){google.maps.event.trigger(h.skmap.markers[i.getMap(m)][0],"click")}}if(n){if(f.spider===true){h.skmap.oms[i.getMap(m)]=new OverlappingMarkerSpiderfier(h.skmap.mapHash[i.getMap(m)].map,{markersWontMove:true,markersWontHide:true});for(var l=0;l<c;l++){h.skmap.markers[i.getMap(m)].push(h.skmap.oms[i.getMap(m)].addMarker(e.addMarker(m,j.features[l])))}h.skmap.markerManager.push(new MarkerClusterer(h.skmap.mapHash[i.getMap(m)].map,h.skmap.oms[i.getMap(m)].getMarkers(),b))}else{for(var l=0;l<c;l++){h.skmap.markers[i.getMap(m)].push(e.addMarker(m,j.features[l]))}h.skmap.markerManager[i.getMap(m)]=new MarkerClusterer(h.skmap.mapHash[i.getMap(m)].map,h.skmap.markers[i.getMap(m)],b)
}}else{google.maps.event.addListener(h.skmap.markerManager[i.getMap(m)],"loaded",function(){updateClusterer()})}if(f.geolocation.active===true){google.maps.event.addListenerOnce(h.skmap.mapHash[i.getMap(m)].map,"idle",function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(p){var o,q,r;h.skmap.rawPosition[i.getMap(m)]=p.coords;o=new google.maps.LatLng(p.coords.latitude,p.coords.longitude);h.skmap.mapHash[i.getMap(m)].map.setCenter(o);h.skmap.mapHash[i.getMap(m)].map.setZoom(10);q=e.makeLatLng([p.coords.longitude,p.coords.latitude]);g=new google.maps.Marker({position:q,icon:f.geolocation.marker,map:k});h.skmap.markers[i.getMap(m)].push(g);h.skmap.markerManager[i.getMap(m)].clearMarkers();h.skmap.markerManager[i.getMap(m)]=new MarkerClusterer(h.skmap.mapHash[i.getMap(m)].map,h.skmap.markers[i.getMap(m)],b);r=new google.maps.Geocoder();r.geocode({latLng:o},function(s,t){if(t==google.maps.GeocoderStatus.OK){f.geolocation.onGeolocation(h.skmap.mapHash[i.getMap(m)].map,h.skmap.rawPosition[i.getMap(m)],s)}})},e.geolocationError)}else{e.geolocationError({code:0})}})}},init:function(m,l,n){b={gridSize:l.clusterer.grid_size,maxZoom:l.clusterer.max_zoom,styles:l.clusterer.style};if(l.data!=""||typeof l.data=="object"){if(typeof l.data=="string"){h.getJSON(l.data,function(o){j=o;e.set(m,n)})}else{j=l.data;e.set(m,n)}}else{console.log("Please, insert a valide geoJSON url or passing a geoJSON Object!")}}},i={getMap:function(m){for(var l=0;l<h.skmap.mapHash.length;l++){if(h.skmap.mapHash[l].mapKey==m){return l}}},setInfobox:function(l){var n,m;m=f.infoboxSettings.offset;n={content:l,disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(m[0],m[1]),zIndex:null,boxStyle:{background:"url("+f.infoboxSettings.background+") left top no-repeat",opacity:1,width:f.infoboxSettings.width,height:f.infoboxSettings.height},closeBoxMargin:f.infoboxSettings.closeBoxMargin,closeBoxURL:f.infoboxSettings.closeBoxURL,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};return n},attachEvent:function(l){h("a.open-infowindow",f.sidebar.target).die("click");h("a.open-infowindow",f.sidebar.target).live("click",function(){var m=parseInt(h(this).data("marker"),10);google.maps.event.trigger(h.skmap.gmarkers[i.getMap(l)][m],"click");h.skmap.mapHash[i.getMap(l)].map.setCenter(h.skmap.gmarkers[i.getMap(l)][m].getPosition());h.skmap.mapHash[i.getMap(l)].map.setZoom(15);return false})}},d={init:function(l){f={data:"",action:"infowindow",markerClick:function(m){},autoOpen:false,spider:false,sidebar:{active:false,mid:null,target:""},defaultPoint:{lat:0,lng:0},clusterer:{grid_size:50,max_zoom:15,style:[]},categoryIcons:{field_name:"",options:{},size:[32,32],origin:[0,0],anchor:[0,0]},geolocation:{active:false,marker:"",manualCoords:[],onGeolocation:function(o,n,m){},onError:function(m){}},infowindowOptions:{},infoboxSettings:{offset:[0,0],width:"",height:"",background:"",closeBoxMargin:"0 0 0 0",closeBoxURL:""},mapOptions:{},mapStyle:[]};return this.each(function(){var m;if(l){if(typeof l[1]=="object"){m=l[0];h.extend(f,l[1])}else{h.extend(f,l)}}e.init(this,f,m)})},destroy:function(){this.each(function(){var m=jQuery(this).empty().removeAttr("style").clone(false);var l=i.getMap(this);h.skmap.mapHash.splice(l,1);h.skmap.markerManager.splice(l,1);h.skmap.markers.splice(l,1);h.skmap.gmarkers.splice(l,1);h.skmap.infowindows.splice(l,1);h.skmap.rawPosition.splice(l,1);h.skmap.oms.splice(l,1);h(this).replaceWith(m)})}};h.fn.shakemap=function(l){switch(l){case"update":return d.init.apply(this,[arguments]);break;case"destroy":return d.destroy.apply(this);break;default:return d.init.apply(this,arguments);break}}})(jQuery);