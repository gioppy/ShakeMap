(function(a){a.shakeMap=function(y,f){var w,i,k,e,A,u,l,j,h,x,n,t,p,o,c;y=(typeof y=="string")?a(y).get(0):y;if(!(a(y).data("shakeMap"))){w=a.extend(true,{},a.shakeMap.defaults);a.extend(true,w,f);o={gridSize:w.grid_size,maxZoom:w.max_zoom,styles:w.cluster_styles};var s=function(G,D){var F,E;k=[];n=[];if(G){t=D}else{t=w.data}p=t.points.length;j=g(G);if(G){u.clearMarkers();google.maps.event.trigger(A,"resize");A.fitBounds(j);if(w.use_spider==true){c.clearMarkers()}}else{A=r();if(w.use_spider==true){c=new OverlappingMarkerSpiderfier(A,{markersWontMove:true,markersWontHide:true});for(var B=0;B<p;B++){k.push(c.addMarker(b(t.points[B])))}u=new MarkerClusterer(A,c.getMarkers(),o);c.addListener("click",function(H){z(H)})}else{for(var B=0;B<p;B++){k.push(b(t.points[B]));z(k[B])}u=new MarkerClusterer(A,k,o)}if(w.clusterer_styles.length!=0){var C=w.clusterer_styles;u.setStyles(C)}if(w.use_geo==true){navigator.geolocation.getCurrentPosition(d,v)}}if(G){if(w.use_spider==true){c=new OverlappingMarkerSpiderfier(A,{markersWontMove:true,markersWontHide:true});for(var B=0;B<p;B++){k.push(c.addMarker(b(t.points[B])))}u=new MarkerClusterer(A,c.getMarkers(),o);c.addListener("click",function(H){z(H)})}else{for(var B=0;B<p;B++){k.push(b(t.points[B]));z(k[B])}u=new MarkerClusterer(A,k,o)}}else{google.maps.event.addListener(u,"loaded",function(){m()})}if(w.resizer!=""){a(w.resizer).click(function(){var H=A.getCenter();var I="#"+A.b.id;a(I).animate({height:w.resizer_height},500,function(){google.maps.event.trigger(A,"resize");A.setCenter(H)});return false})}};var d=function(B){var C=B.coords;A.setCenter(new google.maps.LatLng(C.latitude,C.longitude));A.setZoom(10);var E=a.shakeMap.makeGLatLng({lat:C.latitude,lng:C.longitude});var D=new google.maps.Marker({position:E,icon:"home.png",map:A});k.push(D);u.clearMarkers();u=new MarkerClusterer(A,k,o)};var v=function(B){console.log(B)};var r=function(){var B,E,D,F,C;if(w.style!=false){B="custom";if(w.styles){E=w.styles}D={navigationControlOptions:{style:google.maps.NavigationControlStyle.LARGE},mapTypeControl:false,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,B]},mapTypeId:B,zoom:9,scrollwheel:false};F={name:"custom"};C=new google.maps.StyledMapType(E,F);A=new google.maps.Map(y,D);A.mapTypes.set(B,C)}else{D={zoomControlOptions:{style:google.maps.ZoomControlStyle.DEFAULT},mapTypeId:google.maps.MapTypeId.ROADMAP,maxZoom:18,zoom:9};A=new google.maps.Map(y,D)}if(p>1){A.fitBounds(j)}else{A.setCenter(new google.maps.LatLng(t.points[0].point.lat,t.points[0].point.lng));if(w.force_zoom_level){A.setZoom(w.force_zoom_level)}}return A};var g=function(G){var F,E,D;if(p){E=a.shakeMap.makeGLatLng(t.points[0].point)}else{E=a.shakeMap.makeGLatLng(setting.default_point)}F=new google.maps.LatLngBounds(E,E);D=t.points.length;for(var C=1,B=D;C<B;C++){F.extend(a.shakeMap.makeGLatLng(t.points[C].point))}return F};var q=function(C){if(w.category_icon_options){var B=w.category_icon_options;return B[C]||B["default"]}else{return{}}};var b=function(B){var M=a(B),C,L,J,K,G,I,H,D,F,E;L=a.shakeMap.makeGLatLng(B.point);if(w.category_icon_options){F=q(B.point.categoria);I=new google.maps.Marker({icon:F,position:L,map:A})}else{I=new google.maps.Marker({position:L,map:A})}if(B.point.url){I.url=B.point.url}if(B.point.informazioni){I.desc=B.point.informazioni}return I};var z=function(C){switch(w.marker_action){case"infowindow":info_window=new google.maps.InfoWindow({content:a("<div/>").html(C.desc).text()});n.push(info_window);if(w.use_spider==true){a.each(n,function(G,H){if(info_window!=H){H.close()}});info_window.open(A,C)}else{google.maps.event.addListener(C,"click",function(){a.each(n,function(G,H){if(info_window!=H){H.close()}});info_window.open(A,C)})}break;case"infobox":var F,D,E,B;F=w.infobox_settings.offset;E={content:a("<div/>").html(C.desc).text(),disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(F[0],F[1]),zIndex:null,boxStyle:{background:"url("+w.infobox_settings.background+") left top no-repeat",opacity:1,width:w.infobox_settings.width,height:w.infobox_settings.height},closeBoxMargin:w.infobox_settings.closeBoxMargin,closeBoxURL:w.infobox_settings.closeBoxURL,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};B=new InfoBox(E);n.push(B);if(w.use_spider==true){a.each(n,function(G,H){if(B!=H){H.close()}});B.open(A,C)}else{google.maps.event.addListener(C,"click",function(){a.each(n,function(G,H){if(B!=H){H.close()}});B.open(A,C)})}break;case"click":if(w.use_spider==true){w.onClick(C)}else{google.maps.event.addListener(C,"click",function(){w.onClick(this)})}break}};var m=function(){if(w.always_show_markers==true){min_zoom=0}u.addMarkers(k)};if(a(document).trigger("beforeMapping.shakeMap",[w])!=false){s();e=true}else{e=false}x={gmarkers:i,settings:w,mapped:e,map:A,getBounds:g,update:function(B){if(a(document).trigger("beforeUpdate.jMapping",[this])!=false){s(true,B);this.map=A;this.marker=k;this.markerManager=u;a(document).trigger("afterUpdate.shakeMap",[this])
}}};a(document).trigger("afterMapping.shakeMap",[x]);return x}else{return a(y).data("shakeMap")}};a.extend(a.shakeMap,{defaults:{data:{},grid_size:50,max_zoom:15,clusterer_styles:[],default_point:{lat:0,lng:0},use_geo:false,styled:false,styled_obj:{},infobox_settings:{offset:[0,0],width:"",height:"",background:"",closeBoxMargin:"9px 38px 2px 2px",closeBoxURL:""},marker_action:"infowindow",resizer:"",resizer_height:0,use_spider:false,onClick:function(b){}},makeGLatLng:function(b){return new google.maps.LatLng(b.lat,b.lng)}});a.fn.shakeMap=function(c,b){if((c=="update")&&a(this[0]).data("shakeMap")){a(this[0]).data("shakeMap").update(b)}else{if(c=="update"){c={}}a(this[0]).data("shakeMap",a.shakeMap(this[0],c))}return this}})(jQuery);